FROM ubuntu:18.04 as builder

RUN apt update && apt install -y \
  libboost-dev \
  libboost-test-dev \
  python3-dev \
  build-essential clang cmake git wget subversion vim

WORKDIR /root/develop

ENV MSAN_CFLAGS="-stdlib=libc++ -g -O1"

RUN git clone https://github.com/GMLC-TDC/HELICS.git
RUN cd HELICS && mkdir build  && cd build && cmake .. -DBUILD_SHARED_LIBS=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -DBUILD_HELICS_BOOST_TESTS=OFF -DZMQ_SUBPROJECT=ON  -DZMQ_FORCE_SUBPROJECT=ON
RUN cd HELICS && cd build && make -j 12 install
RUN /root/develop/HELICS/build/tests/helics/core/core-tests
RUN /root/develop/HELICS/build/tests/helics/common/common-tests
RUN /root/develop/HELICS/build/tests/helics/system_tests/system-tests
# Create script to build helics

ENV PYTHONPATH /usr/local/python

# Python must be installed after the PYTHONPATH is set above for it to
# recognize and import libhelicsSharedLib.so.
RUN apt install -y --no-install-recommends python3-dev \
  && rm -rf /var/lib/apt/lists/*


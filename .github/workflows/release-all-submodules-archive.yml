name: Release all submodules archive

on: [release]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1
    - name: Event dump
      run: cat $GITHUB_EVENT_PATH
    - name: Run a multi-line script
      run: |
        echo $(jq --raw-output '.action' $GITHUB_EVENT_PATH)
        echo $(jq --raw-output '.release.upload_url' $GITHUB_EVENT_PATH)
    - name: Create archive
      run: ./scripts/_git-all-archive.sh -t $GITHUB_REF
    - name: Upload archive to release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        AUTH_HEADER="Authorization: token ${GITHUB_TOKEN}"
        RELEASE_ID=$(jq --raw-output '.release.id' $GITHUB_EVENT_PATH)
        FILE="Helics-${GITHUB_REF}.tar.gz"
        CONTENT_TYPE="$(file -b --mime-type $FILE)"
        CONTENT_LENGTH="$(stat -c%s "$FILE")"
        UPLOAD_URL="https://uploads.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID}/assets?name=${FILE}"
        curl \
        -sSL \
        -XPOST \
        -H "${AUTH_HEADER}" \
        -H "Content-Length ${CONTENT_LENGTH}" \
        -H "Content-Type: ${CONTENT_TYPE}" \
        --upload-file "${FILE}" \
        "${UPLOAD_URL}"

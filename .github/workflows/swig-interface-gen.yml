name: Generate SWIG Interfaces

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    container:
      image: helics/buildenv:interface-gen
    
    steps:
    - uses: actions/checkout@v1
    - name: Run SWIG
      run: |
        mkdir build_matlab
        pushd build_matlab
        cmake -DBUILD_MATLAB_INTERFACE=ON -DHELICS_SWIG_GENERATE_INTERFACE_FILES_ONLY=ON -DHELICS_OVERWRITE_INTERFACE_FILES=ON -DHELICS_BUILD_EXAMPLES=OFF -DENABLE_ZMQ_CORE=OFF -DHELICS_BUILD_TESTS=OFF -DHELICS_BUILD_APP_EXECUTABLES=OFF -DHELICS_DISABLE_BOOST=ON -DHELICS_ENABLE_SWIG=ON -DSWIG_EXECUTABLE=/root/swig-matlab/bin/swig ..
        make -j2 mfile_overwrite
        popd
        mkdir build_interface
        pushd build_interface
        cmake -DBUILD_PYTHON_INTERFACE=ON -DBUILD_JAVA_INTERFACE=ON -DHELICS_SWIG_GENERATE_INTERFACE_FILES_ONLY=ON -DHELICS_OVERWRITE_INTERFACE_FILES=ON -DHELICS_BUILD_EXAMPLES=OFF -DENABLE_ZMQ_CORE=OFF -DHELICS_BUILD_TESTS=OFF -DHELICS_BUILD_APP_EXECUTABLES=OFF -DHELICS_DISABLE_BOOST=ON -DHELICS_ENABLE_SWIG=ON ..
        make -j2 pyfile_overwrite
        make -j2 javafile_overwrite
        popd
    - name: Check changed files
      run: |
        git diff --name-only | grep -E 'interfaces/*' > swig-changed-files.txt
        if [[ "$?" == "0" ]];
        then
          hash=$(sha256sum $(cat swig-changed-files.txt) | sha256sum | cut -c 1-5 -)
          echo "ChangeHash=$hash"
          echo "::set-env name=CREATE_PR_BRANCH::swig-update-${hash}"
        fi
        rm swig-changed-files.txt
    - uses: ./.github/actions/create-file-update-pr
